# KataGo victimplay training on svm.
# Based off of selfplay training documented at
# https://github.com/lightvector/KataGo/blob/master/SelfplayTraining.md.
#
# svm resources:
#   - 64 CPUs
#   - 4 GPUs
#     - NVIDIA GeForce GTX 1080 Ti, 11178 MB of memory
#
# See https://stackoverflow.com/a/52641495/1337463 for documentation on how to
# run commands with `sh -c`.
#
# Launch command on svm (run from repo root).
# docker-compose -f compose/svm-victimplay.yml --env-file compose/svm-victimplay.env up

version: "3"

services:
  victimplay:
    image: humancompatibleai/goattack:cpp
    build:
      context: ..
      dockerfile: ./compose/cpp/Dockerfile
    volumes:
      - type: bind
        source: $HOST_OUTPUT_DIR
        target: /outputs
      - type: bind
        source: $HOST_MODEL_DIR
        target: /models
    command: >
      sh -c "
        cd /engines/KataGo-custom &&
        ./cpp/katago victimplay \
        -output-dir /outputs/selfplay \
        -models-dir /outputs/models \
        -config $VICTIMPLAY_CONFIG
      "
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
              driver: nvidia
              device_ids: ["0", "1", "2"]

  train:
    image: humancompatibleai/goattack:python
    build:
      context: ..
      dockerfile: ./compose/python/Dockerfile
    volumes:
      - type: bind
        source: $HOST_OUTPUT_DIR
        target: /outputs
    command: >
      sh -c "
        cd /engines/KataGo-custom/python &&
        ./selfplay/train.sh \
        /outputs/ \
        $TRAININGNAME \
        b6c96 \
        $BATCH_SIZE \
        main \
        -lr-scale 1.0
      "
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
              driver: nvidia
              device_ids: ["3"]

  shuffle-and-export:
    image: humancompatibleai/goattack:python
    build:
      context: ..
      dockerfile: ./compose/python/Dockerfile
    volumes:
      - type: bind
        source: $HOST_OUTPUT_DIR
        target: /outputs
    command: >
      sh -c "
        cd /engines/KataGo-custom/python &&
        ./selfplay/shuffle_and_export_loop.sh \
        $NAMEOFRUN \
        /outputs/ \
        $SCRATCH_DIRECTORY \
        $NUM_THREADS \
        $BATCH_SIZE \
        $USE_GATING &&
        sleep infinity
      "
    # shuffle_and_export_loop.sh disowns subprocesses and exits, which is why we
    # sleep at the end so the docker container doesn't exit.
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
              driver: nvidia
              device_ids: ["3"]
