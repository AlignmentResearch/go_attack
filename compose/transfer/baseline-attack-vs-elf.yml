# Launches a baseline attack on ELF OpenGo.
version: "3"

services:
  victim:
    image: humancompatibleai/goattack:elf
    build:
      context: ../../engines/elf
    command: [
      # Exposes ELF on port 80.
      "socat", "TCP4-LISTEN:80,reuseaddr,fork", "EXEC:'./gtp-defaults.sh'"
    ]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
              driver: nvidia
              device_ids: ["0"]
  baseline_attack:
    image: humancompatibleai/goattack:cpp
    build:
      context: ../..
      dockerfile: ../compose/cpp/Dockerfile
      target: prod
    depends_on:
      - victim
    command: [
      "python3", "-u", "/go_attack/scripts/baseline_attack.py",
      "--config", "/go_attack/configs/katago/baseline_attack.cfg",
      "--executable", "/engines/connect-to-victim.sh", "--no-suicide",
      "--models", "/dev/null", "--num-games", "2", "--verbose"
    ]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
              driver: nvidia
              device_ids: ["0"]
